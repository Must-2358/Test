-- Services 
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- ===== SUBSCRIPTION EXPIRY SYSTEM =====
-- Set your expiration date in IST (Indian Standard Time)
local EXPIRY_DATE = {
    Year = 2026,    -- Change this
    Month = 1,     -- Change this
    Day = 2,       -- Change this
    Hour = 0,      -- 24-hour format
    Minute = 0,
    Second = 0
}

-- Convert IST to UTC (IST = UTC+5:30)
local function getCurrentIST()
    local utcTime = os.time(os.date("!*t"))
    local istOffset = 5.5 * 3600  -- 5.5 hours in seconds
    return utcTime + istOffset
end

-- Check if subscription has expired
local function isSubscriptionActive()
    local currentTime = getCurrentIST()
    local expiryTime = os.time({
        year = EXPIRY_DATE.Year,
        month = EXPIRY_DATE.Month,
        day = EXPIRY_DATE.Day,
        hour = EXPIRY_DATE.Hour,
        min = EXPIRY_DATE.Minute,
        sec = EXPIRY_DATE.Second
    }) - (5.5 * 3600)  -- Convert expiry time from IST to UTC for comparison
    
    return currentTime <= expiryTime
end

-- Show expiry notification and stop script
if not isSubscriptionActive() then
    warn("‚ö†Ô∏è Script Subscription Expired!")
    local CoreGui = game:GetService("CoreGui")
    
    -- Create expiry notification
    local gui = Instance.new("ScreenGui")
    gui.Name = "SubscriptionExpired"
    gui.Parent = CoreGui
    
    local frame = Instance.new("Frame")
    frame.Size = UDim2.new(0, 300, 0, 150)
    frame.Position = UDim2.new(0.5, -150, 0.5, -75)
    frame.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    frame.BorderSizePixel = 0
    frame.AnchorPoint = Vector2.new(0.5, 0.5)
    Instance.new("UICorner", frame).CornerRadius = UDim.new(0, 12)
    frame.Parent = gui
    
    local title = Instance.new("TextLabel")
    title.Size = UDim2.new(1, -20, 0, 40)
    title.Position = UDim2.new(0, 10, 0, 10)
    title.Text = "‚ö†Ô∏è SUBSCRIPTION EXPIRED ‚ö†Ô∏è"
    title.TextColor3 = Color3.fromRGB(255, 50, 50)
    title.TextSize = 16
    title.Font = Enum.Font.GothamBold
    title.BackgroundTransparency = 1
    title.Parent = frame
    
    local message = Instance.new("TextLabel")
    message.Size = UDim2.new(1, -20, 0, 60)
    message.Position = UDim2.new(0, 10, 0, 50)
    message.Text = "This script has expired.\n\nExpired on: " .. 
                   string.format("%02d/%02d/%04d %02d:%02d IST", 
                   EXPIRY_DATE.Day, EXPIRY_DATE.Month, EXPIRY_DATE.Year,
                   EXPIRY_DATE.Hour, EXPIRY_DATE.Minute)
    message.TextColor3 = Color3.new(1, 1, 1)
    message.TextSize = 14
    message.Font = Enum.Font.Gotham
    message.BackgroundTransparency = 1
    message.TextWrapped = true
    message.Parent = frame
    
    local closeBtn = Instance.new("TextButton")
    closeBtn.Size = UDim2.new(0, 100, 0, 30)
    closeBtn.Position = UDim2.new(0.5, -50, 1, -45)
    closeBtn.Text = "CLOSE"
    closeBtn.TextColor3 = Color3.new(1, 1, 1)
    closeBtn.BackgroundColor3 = Color3.fromRGB(100, 0, 0)
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 14
    Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 6)
    closeBtn.MouseButton1Click:Connect(function() 
        gui:Destroy()
    end)
    closeBtn.Parent = frame
    
    -- Add to allowed users list so they know
    local allowedMessage = Instance.new("TextLabel")
    allowedMessage.Size = UDim2.new(1, -20, 0, 20)
    allowedMessage.Position = UDim2.new(0, 10, 0, 120)
    allowedMessage.Text = ""
    allowedMessage.TextColor3 = Color3.fromRGB(0, 170, 255)
    allowedMessage.TextSize = 12
    allowedMessage.Font = Enum.Font.Gotham
    allowedMessage.BackgroundTransparency = 1
    allowedMessage.Parent = frame
    
    return -- Stop script execution
end

-- Get username
local playerUsername = LocalPlayer.Name

-- Username
local ALLOWED_USERNAMES = {
    "itzme_AD7",
    "Must2359",
    "4RISING_DE4TH",
    "h8rBKLe" , 
    "traqdeplayz" , 
    "BKLh8r" , 
    "JUICE_PILADO52", 
    "maddy737398",
    "chauhan09091",
    "Arya_2010999"
}

-- Check
local function isPlayerAuthorized()
    for _, username in ipairs(ALLOWED_USERNAMES) do
        if playerUsername == username then
            return true
        end
    end
    return false
end

-- Stop
if not isPlayerAuthorized() then
    return
end

-- Services 
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local CoreGui = game:GetService("CoreGui")
local TextChatService = game:GetService("TextChatService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Chat = game:GetService("Chat")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")

-- JSON File Management
local DATA_FILE_NAME = "MiniBypasser_Data.json"
local isSynapse = pcall(function() return syn end)

-- Load saved data from file
local function loadSavedData()
    if not isSynapse then return nil end
    
    local success, data = pcall(function()
        if readfile then
            if isfile(DATA_FILE_NAME) then
                local fileContent = readfile(DATA_FILE_NAME)
                return HttpService:JSONDecode(fileContent)
            end
        end
        return nil
    end)
    
    return success and data or nil
end

-- Save data to file
local function saveData(data)
    if not isSynapse then return false end
    
    local success = pcall(function()
        if writefile then
            writefile(DATA_FILE_NAME, HttpService:JSONEncode(data))
            return true
        end
        return false
    end)
    
    return success
end

-- Delete data file
local function deleteDataFile()
    if not isSynapse then return false end
    
    local success = pcall(function()
        if delfile and isfile(DATA_FILE_NAME) then
            delfile(DATA_FILE_NAME)
            return true
        end
        return false
    end)
    
    return success
end

-- NEW: Optimized format function that reduces pattern instead of message
local function formatWithPattern(message, clearPattern)
    -- Use "__" as default if pattern is empty
    local pattern = clearPattern
    if pattern == nil or pattern == "" then
        pattern = "__"
    end
    
    local targetLength = 200
    
    -- First, calculate how many pattern repeats we can fit before the message
    local messageLength = utf8.len(message) or #message
    local availableSpace = targetLength - messageLength
    
    if availableSpace <= 0 then
        -- Message is already 200+ characters, truncate message instead of pattern
        return string.sub(message, 1, targetLength)
    end
    
    -- Calculate how many full patterns we can fit
    local patternLength = #pattern
    if patternLength == 0 then patternLength = 1 end
    
    local fullPatterns = math.floor(availableSpace / patternLength)
    local remainingSpace = availableSpace - (fullPatterns * patternLength)
    
    -- Build the final message
    local finalPattern = string.rep(pattern, fullPatterns)
    
    -- Add remaining characters if any
    if remainingSpace > 0 and patternLength > 0 then
        finalPattern = finalPattern .. string.sub(pattern, 1, remainingSpace)
    end
    
    return finalPattern .. message
end

-- GUI 
pcall(function() 
    if CoreGui:FindFirstChild("MiniBypasser") then 
        CoreGui:FindFirstChild("MiniBypasser"):Destroy() 
    end 
end)

local gui = Instance.new("ScreenGui") 
gui.Name = "MiniBypasser" 
gui.ResetOnSpawn = false 
gui.Parent = CoreGui

-- Load saved data if it exists
local savedData = loadSavedData()
local autoStartData = nil

if savedData and savedData.noCooldownEnabled then
    autoStartData = savedData
    warn("üìÅ Loaded saved data for auto-start")
end

-- Main Frame (adjusted for new boxes) 
local main = Instance.new("Frame") 
main.Size = UDim2.new(0, 220, 0, 210)  -- Increased height for new button
main.Position = UDim2.new(0.5, -110, 0.5, -105)  -- Adjusted position
main.BackgroundColor3 = Color3.fromRGB(40, 40, 40) 
main.BorderSizePixel = 0 
main.AnchorPoint = Vector2.new(0.5, 0.5) 
main.Active = true 
main.Draggable = true 
main.Parent = gui 
Instance.new("UICorner", main).CornerRadius = UDim.new(0, 12)

-- Title 
local title = Instance.new("TextLabel") 
title.Size = UDim2.new(1, -40, 0, 24) 
title.Position = UDim2.new(0, 10, 0, 2) 
title.Text = "SCRIPT FOR KNOX 1/12 TO 1/1" 
title.TextColor3 = Color3.new(1,1,1) 
title.TextSize = 12
title.Font = Enum.Font.GothamBold 
title.BackgroundTransparency = 1 
title.Parent = main

-- Close button 
local closeBtn = Instance.new("TextButton") 
closeBtn.Size = UDim2.new(0, 20, 0, 20) 
closeBtn.Position = UDim2.new(1, -24, 0, 2) 
closeBtn.Text = "X" 
closeBtn.TextColor3 = Color3.new(1, 1, 1) 
closeBtn.BackgroundTransparency = 0.2 
closeBtn.BackgroundColor3 = Color3.fromRGB(100, 0, 0) 
closeBtn.Font = Enum.Font.GothamBold 
closeBtn.TextSize = 12 
Instance.new("UICorner", closeBtn).CornerRadius = UDim.new(0, 6) 
closeBtn.MouseButton1Click:Connect(function() gui:Destroy() end) 
closeBtn.Parent = main

-- Target Name box 
local targetBox = Instance.new("TextBox") 
targetBox.Size = UDim2.new(1, -20, 0, 28) 
targetBox.Position = UDim2.new(0, 10, 0, 32) 
targetBox.PlaceholderText = "Enter H8TER Name" 
targetBox.ClearTextOnFocus = false
targetBox.Text = autoStartData and autoStartData.h8terName or "" 
targetBox.BackgroundColor3 = Color3.fromRGB(60,60,60) 
targetBox.TextColor3 = Color3.new(1,1,1) 
targetBox.Font = Enum.Font.Gotham 
targetBox.TextSize = 13 
Instance.new("UICorner", targetBox).CornerRadius = UDim.new(0,6) 
targetBox.Parent = main

-- Delay box 
local delayBox = Instance.new("TextBox") 
delayBox.Size = UDim2.new(1, -20, 0, 28) 
delayBox.Position = UDim2.new(0, 10, 0, 65) 
delayBox.PlaceholderText = "Delay (min: 0.001)" 
delayBox.ClearTextOnFocus = true
delayBox.Text = autoStartData and tostring(autoStartData.delay) or "" 
delayBox.BackgroundColor3 = Color3.fromRGB(60,60,60) 
delayBox.TextColor3 = Color3.new(1,1,1) 
delayBox.Font = Enum.Font.Gotham 
delayBox.TextSize = 13 
Instance.new("UICorner", delayBox).CornerRadius = UDim.new(0,6) 
delayBox.Parent = main

-- Clear chat pattern box 
local clearBox = Instance.new("TextBox") 
clearBox.Size = UDim2.new(1, -20, 0, 28) 
clearBox.Position = UDim2.new(0, 10, 0, 98) 
clearBox.PlaceholderText = "Clear pattern (e.g., ___)" 
clearBox.ClearTextOnFocus = true
clearBox.Text = autoStartData and autoStartData.pattern or "" 
clearBox.BackgroundColor3 = Color3.fromRGB(60,60,60) 
clearBox.TextColor3 = Color3.new(1,1,1) 
clearBox.Font = Enum.Font.Gotham 
clearBox.TextSize = 13 
Instance.new("UICorner", clearBox).CornerRadius = UDim.new(0,6) 
clearBox.Parent = main

-- No Cooldown Mode button
local noCooldownBtn = Instance.new("TextButton")
noCooldownBtn.Size = UDim2.new(1, -20, 0, 28)
noCooldownBtn.Position = UDim2.new(0, 10, 0, 131)
noCooldownBtn.Text = autoStartData and "‚úÖ NO COOLDOWN" or "‚ùå NO COOLDOWN"
noCooldownBtn.BackgroundColor3 = autoStartData and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(100, 100, 100)
noCooldownBtn.TextColor3 = Color3.new(1,1,1)
noCooldownBtn.Font = Enum.Font.GothamBold
noCooldownBtn.TextSize = 13
Instance.new("UICorner", noCooldownBtn).CornerRadius = UDim.new(0,6)
noCooldownBtn.Parent = main

-- Toggle button (Start/Stop in one) 
local toggleBtn = Instance.new("TextButton") 
toggleBtn.Size = UDim2.new(1, -20, 0, 36) 
toggleBtn.Position = UDim2.new(0, 10, 0, 164) 
toggleBtn.Text = "‚ñ∂ Start" 
toggleBtn.BackgroundColor3 = Color3.fromRGB(0,170,255) 
toggleBtn.TextColor3 = Color3.new(1,1,1) 
toggleBtn.Font = Enum.Font.GothamBold 
toggleBtn.TextSize = 14 
Instance.new("UICorner", toggleBtn).CornerRadius = UDim.new(0,6) 
toggleBtn.Parent = main

-- Predefined lines 
local predefinedLines = { 
"%s TMKX MAI SU4R",
"%s TMKX MAI SL4P",
"%s TMKX MAI B3LT M4RKS",
"%s TMKX MAI THOR KA HTODA",
"%s TMKX MAI BEN 10",
"%s TMKX MAI JAADU",
"%s TMKX MAI DISH TV",
"%s TMKX MAI L0VE B1TE",
"%s TMKX MAI HELICOPTER SH0T",
"%s TMKX MAI COVER DRIVE",
"%s TMKX MAI PULL SH0T",
"%s TMKX MAI DOLLY KI CHAI",
"%s TMKX MAI TESLA",
"%s TMKX MAI V12 ENGINE",
"%s TMKX MAI BABY OIL",
"%s TMKX MAI CASTOR OIL",
"%s TMKX MAI FULJHADI",
"%s TMKX MAI ROCKET",
"%s TMKX MAI TRIDENT",
"%s TMKX MAI JH4NDU B44M",
"%s TMKX MAI K1CK",
"%s TMKX MAI CHOTA BHEEM",
"%s TMKX MAI JAGGU BNDAR",
"%s TMKX MAI JONY BABA",
"%s TMKX MAI FOUNTAIN",
"%s TMKX MAI BROOKHAVEN",
"%s TMKX MAI BLOX FRUIT",
"%s TMKX MAI BRAINROT",
"%s TMKX MAI V1BR4T0R",
"%s TMKX MAI WAK4ND4",
"%s TMKX MAI 1SH0W SPEED",
"%s TMKX MAI SKIBIDI TOILET",
"%s TMKX MAI TUNG TUNG SAHUR",
"%s TMKX MAI BOMBARDINO CROCODILO",
"%s TMKX MAI ALLIEN",
"%s TMKX MAI JAADU KA DH00P",
"%s TMKX MAI J44DU K4 MUTH",
"%s TMKX MAI VIBR4T0R 10X",
"%s TMKX MAI BAAPU JI",
"%s TMKX MAI COMATOZZE",
"%s TMKX MAI KTM RC",
"%s TMKX MAI DORAEMON",
"%s TMKX MAI KACHI",
"%s TMKX MAI NOBITA KE G0T3",
"%s TMKX MAI BLACK HOLE",
"%s TMKX MAI PK KA RADIO",
"%s TMKX MAI NOKIA 3310",
"%s TMKX MAI RTX 5090",
"%s TMKX MAI KLUA",
"%s TMKX MAI HATHI KA LUN",
"%s TMKX MAI BAT KA GRIP",
"%s TMKX MAI 99 NIGHT K DEER",
"%s TMKX MAI CANDY BLOSSOM",
"%s TMKX MAI AAM KA JHAD",
"%s TMKX MAI EV KA MOTOR",
"%s TMKX MAI NEELA DRUM",
"%s TMKX MAI RDP/NC/THUNDER",
"%s TMKX MAI JOGINDER",
"%s TMKX MAI JERRY KA CHEESE",
"%s TMKX MAI BOILING LAVA",
"%s TMKX MAI CREEPER",
"%s TMKX MAI SUPER MARIO",
"%s TMKX MAI NINJA TURTLES",
"%s TMKX MAI ENDERMAN",
"%s TMKX MAI SERBIAN LADY",
"%s TMKX MAI VILLAGER KA THUK",
"%s TMKX MAI GOLLEM KA MUTH",
"%s TMKX MAI TITANOBOA",
"%s TMKX MAI PINK RUSSIAN",
"%s TMKX MAI SIGMATATE",
"%s TMKX MAI P DIDY",
"%s TMKX MAI DRAKE K G0T3",
"%s TMKX MAI MOONWALK",
"%s TMKX MAI SAITAMA K TKLA",
"%s TMKX MAI PAKISTAN",
"%s TMKX MAI BLOOD DEMON ART",
"%s TMKX MAI TAIJUTSU",
"%s TMKX MAI WATER BREATHING",
"%s TMKX MAI GB ROAD",
"%s TMKX MAI HAGEMARU",
"%s TMKX MAI CHATA MARU",
"%s TMKX MAI TNT LGAUN",
"%s TMKX MAI TANJIRO KA MUTH",
"%s TMKX MAI CHAINSAW DAALU",
"%s TMKX MAI DEKU KA LUN",
"%s TMKX MAI MADARA UCHIHA",
"%s TMKX MAI KHEEL TOKHU",
"%s TMKX MAI KHUTA GADUN",
"%s TMKX MAI HEATBLAST K AAG",
"%s TMKX MAI ENDERDRAGON",
"%s TMKX MAI GIAN K SONG",
"%s TMKX MAI RAAJU KA BAAL",
"%s TMKX MAI ALOK KA DJ",
"%s TMKX MAI GLOOWALL",
"%s TMKX MAI ERANGLE MAP",
"%s TMKX MAI ACT1ON K4M3N",
"%s TMKX MAI KALA SANDH",
"%s TMKX MAI POKEMON",
"%s TMKX MAI BHOOT NATH",
"%s TMKX MAI ROAD ROLLER",
"%s TMKX MAI DRAKULA",
"%s TMKX MAI CAPTAIN AMERICA KI SHIELD",
"%s TMKX MAI HULK KA PUNCH",
"%s TMKX MAI SPIDER MAN KA WEB",
"%s TMKX MAI KUTTE KA MUTH",
"%s TMKX MAI GHODE KI NAAL",
"%s TMKX MAI IRON MAN KA LASER",
"%s TMKX MAI LOKI KI CHDI",
"%s TMKX MAI BATMOBILE",
"%s TMKX MAI EINSTEIN KA FORMULA",
"%s TMKX MAI NEWTON KA GRAVITY",
"%s TMKX MAI KIRMADA",
"%s TMKX MAI BAYBLADE",
"%s TMKX MAI PIKACHU",
"%s TMKX MAI POKEBALL",
"%s TMKX MAI CHARMENDAR",
"%s TMKX MAI LASSI",
"%s TMKX MAI 1K YEARS OF DEATH",
"%s TMKX MAI RASENGA",
"%s TMKX MAI CHIDORI",
"%s TMKX MAI SAKURA",
"%s TMKX MAI SHADOW CLONES JUTSU",
"%s TMKX MAI JIRAYA KA GOT4",
"%s TMKX MAI PAIN KA LUN",
"%s TMKX MAI M4D4R4 KA MUTH",
"%s TMKX MAI TSUN4DE KA D00DH",
"%s TMKX MAI MUZAAN KA GOT4",
"%s TMKX MAI DENJI KA LUN",
"%s TMKX MAI LUFFY KA GEAR",
"%s TMKX MAI ZORO KI TLWAR",
"%s TMKX MAI HATHI KE G0T3",
"%s TMKX MAI LASSAN",
"%s TMKX MAI TITAN KA MUTH",
"%s TMKX MAI ASH KA LUN",
"%s TMKX MAI BULBASAUR",
"%s TMKX MAI CHIDORI",
"%s TMKX MAI SUPRA KE PTAKHE",
"%s TMKX MAI PAINT BRUSH",
"%s TMKX MAI COPPER T",
"%s TMKX MAI PURA COM",
"%s TMKX MAI SHINIGAMI",
"%s TMKX MAI NINETAILS",
"%s TMKX MAI SANDE KA OIL",
"%s TMKX MAI NEELA DRUM",
"%s TMKX MAI NADIA",
"%s TMKX MAI DRILLING MACHINE",
"%s TMKX MAI EXCAVATOR",
"%s TMKX MAI LAVA",
"%s TMKX MAI H0T ROD",
"%s TMKX MAI COAL",
"%s TMKX MAI KEED3",
"%s TMKX MAI D0GY POS3",
}

-- Fancy fonts 
local fontHindi = {A = "A", B = "B", C = "C", D = "D", E = "E", F = "F", G = "G",
H = "H", I = "I", J = "J", K = "K", L = "L", M = "M", N = "N",
O = "O", P = "P", Q = "Q", R = "R", S = "S", T = "T", U = "U",
V = "V", W = "W", X = "X", Y = "Y", Z = "Z"}
local fontEnglish = { a = "Œ¨◊Å◊Ö",
b = "b",
c = "œÇ◊Å◊Ö",
d = "d",
e = "e",
f = "≈¶",
g = "g",
h = "h",
i = "i",
j = "j",
k = "“ü",
l = "l",
m = "m",
n = "‡∏ñ",
o = "o",
p = "p",
q = "q",
r = "r",
s = "‡§Ω",
t = "t",
u = "‡∏°",
v = "v",
w = "w",
x = "x",
y = "·û´",
z = "z"}

-- Convert with font 
local function convertFont(msg, font) 
    local result = {} 
    for word in msg:gmatch("%S+") do 
        local fancyWord = {} 
        for _, c in utf8.codes(word) do 
            local char = utf8.char(c) 
            if char:match("[%a]") then 
                table.insert(fancyWord, font[char:lower()] or char) 
            else 
                table.insert(fancyWord, char) 
            end 
        end 
        table.insert(result, table.concat(fancyWord, "")) 
    end 
    return table.concat(result, " ") 
end

-- Send chat with pre-check and custom formatting
local function sendChat(msg, clearPattern)
    -- Format message with user's pattern
    local formattedMsg = formatWithPattern(msg, clearPattern)
    
    local success, filtered = pcall(function()
        return Chat:FilterStringForBroadcast(formattedMsg, LocalPlayer)
    end)
    if not success or filtered ~= formattedMsg then
        return -- blocked, don't send
    end

    if TextChatService.ChatVersion == Enum.ChatVersion.TextChatService then 
        local ok, err = pcall(function() 
            TextChatService.TextChannels.RBXGeneral:SendAsync(formattedMsg) 
        end) 
        if not ok then 
            warn("Chat send fail:", err) 
        end 
    else 
        local chatRemote = ReplicatedStorage:FindFirstChild("DefaultChatSystemChatEvents") 
        if chatRemote and chatRemote:FindFirstChild("SayMessageRequest") then 
            chatRemote.SayMessageRequest:FireServer(formattedMsg, "All") 
        end 
    end 
end

-- Check line with Hindi ‚Üí fallback English
local function checkLineFont(line, targetName)
    local replaced = line:format(targetName)

    local fancyHindi = convertFont(replaced, fontHindi)
    local okH, filteredH = pcall(function()
        return Chat:FilterStringForBroadcast(fancyHindi, LocalPlayer)
    end)
    if okH and filteredH == fancyHindi then
        return "hindi", fancyHindi
    end

    local fancyEng = convertFont(replaced, fontEnglish)
    local okE, filteredE = pcall(function()
        return Chat:FilterStringForBroadcast(fancyEng, LocalPlayer)
    end)
    if okE and filteredE == fancyEng then
        return "english", fancyEng
    end

    return nil, nil
end

-- Loop control 
local running = false 
local cooldownActive = false
local lineFontPreference = {}
local noCooldownEnabled = autoStartData and autoStartData.noCooldownEnabled or false
local currentLineIndex = autoStartData and autoStartData.currentLineIndex or 1
local isAutoRejoining = false

-- Function to save current state
local function saveCurrentState()
    if not noCooldownEnabled then return end
    
    local data = {
        h8terName = targetBox.Text,
        delay = tonumber(delayBox.Text) or 1.5,
        pattern = clearBox.Text or "__",
        noCooldownEnabled = noCooldownEnabled,
        currentLineIndex = currentLineIndex,
        timestamp = os.time()
    }
    
    saveData(data)
    warn("üíæ Saved state to file")
end

-- Function to prepare a batch of lines
local function prepareBatch(startIndex, batchSize, targetName)
    local batch = {}
    local endIndex = math.min(startIndex + batchSize - 1, #predefinedLines)
    
    for i = startIndex, endIndex do
        local line = predefinedLines[i]
        local fancy
        
        local pref = lineFontPreference[i]
        if pref == "hindi" then
            fancy = convertFont(line:format(targetName), fontHindi)
        elseif pref == "english" then
            fancy = convertFont(line:format(targetName), fontEnglish)
        else
            local fontType, msg = checkLineFont(line, targetName)
            if fontType then
                lineFontPreference[i] = fontType
                fancy = msg
            end
        end
        
        if fancy then
            table.insert(batch, {index = i, message = fancy, fontType = lineFontPreference[i]})
        end
    end
    
    return batch, endIndex
end

-- UPDATED: LoopTask with integrated pattern formatting and line tracking
local function loopTask(targetName, customDelay, clearPattern, startFromLine) 
    local batchSize = 10
    local startIndex = startFromLine or 1
    
    -- Use custom delay if provided, otherwise default to 1.5
    local delay = customDelay or 1.5
    
    while running do 
        -- Prepare next batch of lines
        local batch, lastIndex = prepareBatch(startIndex, batchSize, targetName)
        
        if #batch == 0 then
            -- If no messages in batch, restart from beginning
            startIndex = 1
            currentLineIndex = 1
            task.wait(0.1)
            continue
        end
        
        -- Send messages from the current batch
        for _, messageData in ipairs(batch) do
            if not running then break end
            
            -- Wait if cooldown is active
            while cooldownActive do 
                task.wait(0.5) 
            end
            
            -- Update current line index
            currentLineIndex = messageData.index
            
            -- Send the spam message WITH pattern integrated
            sendChat(messageData.message, clearPattern)
            
            -- Wait for the specified delay (custom or default)
            task.wait(delay)
        end
        
        -- Move to next batch
        if lastIndex >= #predefinedLines then
            startIndex = 1 -- Restart from beginning
            currentLineIndex = 1
        else
            startIndex = lastIndex + 1 -- Move to next batch
        end
        
        task.wait(0) -- Small delay between batches
    end 
end

-- Auto-rejoin function
local function autoRejoin()
    if not noCooldownEnabled or isAutoRejoining then return end
    
    isAutoRejoining = true
    warn("üîÑ Auto-rejoining due to cooldown...")
    
    -- Save current state before rejoining
    saveCurrentState()
    
    -- Wait a bit before rejoining
    task.wait(2)
    
    -- Rejoin the game
    local success, errorMsg = pcall(function()
        TeleportService:Teleport(game.PlaceId, LocalPlayer)
    end)
    
    if not success then
        warn("‚ùå Failed to rejoin:", errorMsg)
        isAutoRejoining = false
    end
end

-- Cooldown detection 
TextChatService.MessageReceived:Connect(function(message) 
    if message.Text and message.Text:find("wait before sending another message") then 
        cooldownActive = true 
        
        if noCooldownEnabled and running then
            -- Auto-rejoin if no cooldown mode is enabled
            task.spawn(autoRejoin)
        else
            -- Normal cooldown handling
            task.delay(5, function() 
                cooldownActive = false 
            end) 
        end
    end 
end)

-- Your controller usernames 
local controllerUsernames = {
    "Must2358",
    "itzme_AD7",
    "4RISING_DE4TH"
}

local controllerUserIds = {}
for _, username in ipairs(controllerUsernames) do
    pcall(function() 
        local userId = Players:GetUserIdFromNameAsync(username)
        if userId then
            controllerUserIds[userId] = username
        end
    end)
end

-- Lock system
local botLocked = false
local controllerLocked = false

-- Function to completely lock down the bot (Must2358 only)
local function lockBot()
    botLocked = true
    controllerLocked = false -- Reset controller lock when Must2358 locks
    running = false
    toggleBtn.Text = "üîí LOCKED"
    toggleBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    toggleBtn.Active = false
    
    -- Disable all input boxes
    targetBox.PlaceholderText = "BOT LOCKED"
    targetBox.Text = ""
    targetBox.ClearTextOnFocus = false
    targetBox.Active = false
    
    delayBox.PlaceholderText = "BOT LOCKED"
    delayBox.Text = ""
    delayBox.ClearTextOnFocus = false
    delayBox.Active = false
    
    clearBox.PlaceholderText = "BOT LOCKED"
    clearBox.Text = ""
    clearBox.ClearTextOnFocus = false
    clearBox.Active = false
    
    noCooldownBtn.Text = "‚ùå NO COOLDOWN"
    noCooldownBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    noCooldownBtn.Active = false
    
    -- Make GUI non-draggable when locked
    main.Draggable = false
    
    -- Remove close button functionality when locked
    if closeBtn then
        closeBtn:Destroy()
    end
    
    warn("Bot completely locked by Must2358")
end

-- Function to unlock the bot (Must2358 only)
local function unlockBot()
    botLocked = false
    controllerLocked = false
    toggleBtn.Text = "‚ñ∂ Start"
    toggleBtn.BackgroundColor3 = Color3.fromRGB(0,170,255)
    toggleBtn.Active = true
    
    -- Re-enable all input boxes
    targetBox.PlaceholderText = "Enter H8TER Name"
    targetBox.ClearTextOnFocus = true
    targetBox.Active = true
    
    delayBox.PlaceholderText = "Delay (min: 0.001)"
    delayBox.ClearTextOnFocus = true
    delayBox.Active = true
    
    clearBox.PlaceholderText = "Clear pattern (e.g., ___)"
    clearBox.ClearTextOnFocus = true
    clearBox.Active = true
    
    noCooldownBtn.Active = true
    noCooldownBtn.Text = noCooldownEnabled and "‚úÖ NO COOLDOWN" or "‚ùå NO COOLDOWN"
    noCooldownBtn.BackgroundColor3 = noCooldownEnabled and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(100, 100, 100)
    
    -- Make GUI draggable again
    main.Draggable = true
    
    -- Re-add close button
    local newCloseBtn = Instance.new("TextButton") 
    newCloseBtn.Size = UDim2.new(0, 20, 0, 20) 
    newCloseBtn.Position = UDim2.new(1, -24, 0, 2) 
    newCloseBtn.Text = "X" 
    newCloseBtn.TextColor3 = Color3.new(1, 1, 1) 
    newCloseBtn.BackgroundTransparency = 0.2 
    newCloseBtn.BackgroundColor3 = Color3.fromRGB(100, 0, 0) 
    newCloseBtn.Font = Enum.Font.GothamBold 
    newCloseBtn.TextSize = 12 
    Instance.new("UICorner", newCloseBtn).CornerRadius = UDim.new(0, 6) 
    newCloseBtn.MouseButton1Click:Connect(function() gui:Destroy() end) 
    newCloseBtn.Parent = main
    
    closeBtn = newCloseBtn
    
    warn("Bot unlocked by Must2358")
end

-- Function for controller lock (stops spam but keeps GUI functional)
local function controllerLock()
    controllerLocked = true
    running = false
    toggleBtn.Text = "‚è∏Ô∏è PAUSED"
    toggleBtn.BackgroundColor3 = Color3.fromRGB(255, 165, 0) -- Orange color for pause
    warn("Spam stopped by controller lock")
end

-- Function for controller unlock (only works if not locked by Must2358)
local function controllerUnlock()
    if not botLocked then -- Only unlock if Must2358 hasn't locked it
        controllerLocked = false
        toggleBtn.Text = "‚ñ∂ Start"
        toggleBtn.BackgroundColor3 = Color3.fromRGB(0,170,255)
        warn("Controller lock removed")
    else
        warn("Cannot unlock - bot locked by Must2358")
    end
end

-- No Cooldown button click handler
noCooldownBtn.MouseButton1Click:Connect(function()
    if botLocked then return end
    
    noCooldownEnabled = not noCooldownEnabled
    
    if noCooldownEnabled then
        noCooldownBtn.Text = "‚úÖ NO COOLDOWN"
        noCooldownBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
        warn("‚úÖ No Cooldown mode ENABLED")
        
        -- Save current settings
        local data = {
            h8terName = targetBox.Text,
            delay = tonumber(delayBox.Text) or 1.5,
            pattern = clearBox.Text or "__",
            noCooldownEnabled = true,
            currentLineIndex = currentLineIndex,
            timestamp = os.time()
        }
        
        if saveData(data) then
            sendChat("No Cooldown mode ENABLED - Settings saved", "__")
        end
    else
        noCooldownBtn.Text = "‚ùå NO COOLDOWN"
        noCooldownBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        warn("‚ùå No Cooldown mode DISABLED")
        
        -- Delete the data file
        if deleteDataFile() then
            sendChat("No Cooldown mode DISABLED - Settings cleared", "__")
        end
    end
end)

-- Listen to chat commands from controller 
TextChatService.MessageReceived:Connect(function(message) 
    if not message.Text or not message.TextSource then return end 
    
    local userId = message.TextSource.UserId
    local username = controllerUserIds[userId]
    if not username then return end

    local msg = message.Text   
    local lowerMsg = string.lower(msg)    

    -- Lock bot command (Must2358 - complete lock)
    if lowerMsg == "lock bot" and username == "Must2358" then
        lockBot()
        sendChat("Bot completely locked - only Must2358 can unlock", "__")
        return
    end

    -- Allow bot command (Must2358 - complete unlock)
    if lowerMsg == "allow bot" and username == "Must2358" then
        unlockBot()
        sendChat("Bot unlocked - all controllers can command", "__")
        return
    end

    -- Controller lock command (any controller - stops spam only)
    if lowerMsg == "4mlock" and username ~= "Must2358" then
        controllerLock()
        sendChat("Spam locked by controller", "__")
        return
    end

    -- Controller unlock command (any controller - only works if not locked by Must2358)
    if lowerMsg == "m4allow" and username ~= "Must2358" then
        if botLocked then
            sendChat("Bot locked by Must2358 - cannot unlock", "__")
            return
        else
            controllerUnlock()
            sendChat("Spam unlocked by controller", "__")
            return
        end
    end
    
    -- No Cooldown mode command
    if lowerMsg == "bot no cooldown" or lowerMsg == "bot nocooldown" then
        if botLocked and username ~= "Must2358" then
            return
        end
        
        noCooldownEnabled = not noCooldownEnabled
        
        if noCooldownEnabled then
            noCooldownBtn.Text = "‚úÖ NO COOLDOWN"
            noCooldownBtn.BackgroundColor3 = Color3.fromRGB(0, 170, 0)
            
            -- Save current settings
            local data = {
                h8terName = targetBox.Text,
                delay = tonumber(delayBox.Text) or 1.5,
                pattern = clearBox.Text or "__",
                noCooldownEnabled = true,
                currentLineIndex = currentLineIndex,
                timestamp = os.time()
            }
            
            if saveData(data) then
                sendChat("No Cooldown mode ENABLED by @" .. username, "__")
                warn("No Cooldown mode ENABLED by @" .. username)
            end
        else
            noCooldownBtn.Text = "‚ùå NO COOLDOWN"
            noCooldownBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
            
            -- Delete the data file
            if deleteDataFile() then
                sendChat("No Cooldown mode DISABLED by @" .. username, "__")
                warn("No Cooldown mode DISABLED by @" .. username)
            end
        end
        return
    end

    -- Check if bot is completely locked by Must2358
    if botLocked and username ~= "Must2358" then
        return -- Block ALL commands from other controllers when Must2358 locked
    end

    -- Check if controller lock is active
    if controllerLocked and (lowerMsg == "start spam" or lowerMsg:match("^h8ters name to ")) then
        sendChat("Spam is locked - use 'allow bot' to unlock", "__")
        return
    end

    -- Block bot destroy command when locked by Must2358
    if lowerMsg == "bot destroy" then
        if botLocked and username ~= "Must2358" then
            return -- Block destroy command from others when Must2358 locked
        end
        running = false
        
        -- Delete data file when destroying bot
        if noCooldownEnabled then
            deleteDataFile()
        end
        
        gui:Destroy()
        warn("GUI destroyed by @" .. username)
        return
    end

    -- Force override command
    local num, fontCmd = msg:match("BOT%s+(%d+)%s+LINE%s+(%S+)")
    if num and fontCmd then
        if botLocked and username ~= "Must2358" then
            return -- Block force override when Must2358 locked
        end
        local fontType = string.lower(fontCmd)
        lineFontPreference[tonumber(num)] = fontType
        return
    end
    
    -- NEW: Set delay command
    local delayMatch = lowerMsg:match("bot delay%s+(%d+%.?%d*)")
    if delayMatch then
        local delayNum = tonumber(delayMatch)
        if delayNum and delayNum >= 0.001 and delayNum <= 10 then
            delayBox.Text = tostring(delayNum)
            sendChat(string.format("Delay set to %.3f seconds", delayNum), "__")
            warn("Delay set to " .. delayNum .. " by @" .. username)
            
            -- Save if no cooldown mode is on
            if noCooldownEnabled then
                saveCurrentState()
            end
        else
            sendChat("Delay must be between 0.001 and 10 seconds", "__")
        end
        return
    end
    
    -- NEW: Set clear pattern command
    local patternMatch = msg:match("bot pattern%s+(.+)")
    if patternMatch then
        clearBox.Text = patternMatch
        sendChat("Clear pattern set to: " .. patternMatch, "__")
        warn("Clear pattern set to: " .. patternMatch .. " by @" .. username)
        
        -- Save if no cooldown mode is on
        if noCooldownEnabled then
            saveCurrentState()
        end
        return
    end
    
    if lowerMsg == "soldier" or lowerMsg == "poplu" then
        if username == "Must2358" then
            sendChat("HELLO MUST SIR")
        elseif username == "itzme_AD7" then
            sendChat("ORDER LORD KNOX")
        else
            sendChat("HELLO SIR")
        end
        return   
    elseif string.sub(lowerMsg, 1, 4) == "bot say " then       
        local toSay = string.sub(msg, 5)       
        if toSay ~= "" then           
            sendChat(toSay, "__")       
        end       
        return   
    end    

    if lowerMsg == "bot stop" then       
        running = false       
        toggleBtn.Text = "‚ñ∂ Start"       
        toggleBtn.BackgroundColor3 = Color3.fromRGB(0,170,255)
       
        warn("Spam stopped by @" .. username)   

    elseif lowerMsg == "start spam" then       
        if not running and targetBox.Text ~= "" and not controllerLocked then           
            local targetName = targetBox.Text
            
            -- Get custom delay and clear pattern
            local customDelay = tonumber(delayBox.Text)
            local clearPattern = clearBox.Text
            
            -- Validate delay
            if customDelay and (customDelay < 0.001 or customDelay > 10) then
                sendChat("Delay must be between 0.001 and 10 seconds", "__")
                return
            end
            
            -- Check if we're auto-starting from saved data
            local isAutoStart = autoStartData and not isAutoRejoining
            local waitTime = isAutoStart and 0 or 15
            
            if not isAutoStart then
                sendChat("Spam starting in " .. waitTime .. " seconds..", "__")
            end
            
            -- Immediately update UI
            running = true           
            toggleBtn.Text = "‚ñ† Stop"           
            toggleBtn.BackgroundColor3 = Color3.fromRGB(255,50,50)           

            task.delay(waitTime, function()
                if running then
                    -- Use saved line index if available
                    local startLine = autoStartData and autoStartData.currentLineIndex or 1
                    if startLine > 1 then
                        warn("‚Ü™Ô∏è Resuming from line " .. startLine)
                    end
                    
                    task.spawn(loopTask, targetName, customDelay, clearPattern, startLine)           
                    warn("Spam started by @" .. username)       
                end
            end)
        end   

    elseif lowerMsg:match("^h8ters name to ") then       
        local newName = lowerMsg:gsub("^h8ters name to ", "")       
        if newName ~= "" then           
            targetBox.Text = newName           
            sendChat("H8TERS name changed to: " .. newName, "__")
            warn("H8TERS name changed to: " .. newName)
            
            -- Save if no cooldown mode is on
            if noCooldownEnabled then
                saveCurrentState()
            end
        end   
    end   
end)

toggleBtn.MouseButton1Click:Connect(function() 
    if botLocked then
        return 
    end
    
    if controllerLocked then
        sendChat("Spam is locked - use 'allow bot' to unlock", "__")
        return
    end
    
    if running then 
        running = false 
        toggleBtn.Text = "‚ñ∂ Start" 
        toggleBtn.BackgroundColor3 = Color3.fromRGB(0,170,255) 
        
        -- Save state when stopping (if no cooldown mode is on)
        if noCooldownEnabled then
            saveCurrentState()
        end
    else 
        local targetName = targetBox.Text 
        if targetName == "" then return end 

        -- Get custom delay and clear pattern
        local customDelay = tonumber(delayBox.Text)
        local clearPattern = clearBox.Text
        
        -- Validate delay
        if customDelay and (customDelay < 0.001 or customDelay > 10) then
            sendChat("Delay must be between 0.001 and 10 seconds", "__")
            return
        end
        
        running = true 
        toggleBtn.Text = "‚ñ† Stop" 
        toggleBtn.BackgroundColor3 = Color3.fromRGB(255,50,50) 
        
        -- Check if we're auto-starting
        local isAutoStart = autoStartData and not isAutoRejoining
        local waitTime = isAutoStart and 0.1 or 15
        
        if not isAutoStart then
            sendChat("Spam starting in " .. waitTime .. " seconds", "__")
        else
            warn("üöÄ Auto-starting spam from saved settings")
        end

        task.delay(waitTime, function()
            if running then
                -- Use saved line index if available
                local startLine = autoStartData and autoStartData.currentLineIndex or 1
                if startLine > 1 then
                    warn("‚Ü™Ô∏è Resuming from line " .. startLine)
                end
                
                task.spawn(loopTask, targetName, customDelay, clearPattern, startLine) 
            end
        end)
    end 
end)

-- Auto-start if we have saved data
if autoStartData and not isAutoRejoining then
    warn("üöÄ Auto-start mode activated")
    
    -- Update UI to show we're using saved data
    targetBox.Text = autoStartData.h8terName or ""
    delayBox.Text = tostring(autoStartData.delay or 1.5)
    clearBox.Text = autoStartData.pattern or "__"
    
    -- Start spam automatically after a short delay
    task.wait(1)
    
    if autoStartData.h8terName and autoStartData.h8terName ~= "" then
        toggleBtn.MouseButton1Click:Fire()
    end
    
    -- Clear autoStartData after using it
    autoStartData = nil
end

warn("‚úÖ MiniBypasser loaded successfully!")
if noCooldownEnabled then
    warn("‚úÖ No Cooldown mode is ACTIVE")
end

-- AUTO LOAD SCRIPT AFTER TELEPORT / REJOIN
if queue_on_teleport then
    queue_on_teleport([[
        task.wait(0)
        loadstring(game:HttpGet("https://raw.githubusercontent.com/Must-2358/Test/refs/heads/main/Yes"))();
    ]])
end
